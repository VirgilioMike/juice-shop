name: Security Suite (SAST & DAST with Wapiti)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # 1) Static Application Security Testing (SAST) com Semgrep
  sast_scan:
    name: SAST Scan (Semgrep)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: |
            p/javascript
            p/nodejs-express
          publishToken: ${{ secrets.GITHUB_TOKEN }}

  # 2) Dynamic Application Security Testing (DAST) com Wapiti
  dast_scan:
    name: DAST Scan (Wapiti)
    runs-on: ubuntu-latest
    needs: sast_scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Start Juice Shop in Docker
        run: docker run -d --name juiceshop -p 3000:3000 bkimminich/juice-shop

      - name: Wait for Juice Shop to be ready
        run: |
          echo "‚åõ Esperando http://localhost:3000‚Ä¶"
          for i in $(seq 1 12); do
            if curl --silent --fail http://localhost:3000; then
              echo "‚úÖ Juice Shop est√° UP!"; break
            fi
            echo "‚è≥ tentativa $i/12‚Ä¶"; sleep 5
          done

      - name: Install Wapiti
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3-pip
          pip3 install wapiti3

      - name: Run Wapiti DAST scan
        run: |
          echo "üöÄ Executando Wapiti contra http://localhost:3000"
          wapiti -u http://localhost:3000 \
                 -f html \
                 -o wapiti_report.html

      - name: Upload Wapiti report
        uses: actions/upload-artifact@v4
        with:
          name: wapiti-report
          path: wapiti_report.html
