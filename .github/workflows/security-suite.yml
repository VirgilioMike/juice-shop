name: Security Suite (SAST & DAST with Arachni)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # 1) SAST est√°tico com Semgrep
  sast_scan:
    name: SAST Scan (Semgrep)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: |
            p/javascript
            p/nodejs-express
          publishToken: ${{ secrets.GITHUB_TOKEN }}

  # 2) DAST din√¢mico com Arachni
  dast_scan:
    name: DAST Scan (Arachni)
    runs-on: ubuntu-latest
    needs: sast_scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Start Juice Shop
        run: |
          # Subir container sem escapes que quebrem o nome da imagem
          docker run -d \
            --name juiceshop \
            -p 3000:3000 \
            bkimminich/juice-shop

      - name: Debug: listar containers
        run: |
          echo "üê≥ Containers rodando:"
          docker ps -a

      - name: Wait for Juice Shop to be ready
        run: |
          echo "‚åõ Esperando http://localhost:3000‚Ä¶"
          for i in $(seq 1 12); do
            if curl --silent --fail http://localhost:3000; then
              echo "‚úÖ Juice Shop est√° UP!"; break
            fi
            echo "‚è≥ tentativa $i/12‚Ä¶"; sleep 5
          done

      - name: Pull & Run Arachni scan
        run: |
          CTN=arachni/arachni:latest
          OUT=juice_shop.afr
          HTML=juice_shop.html

          echo "üîÑ puxando $CTN"
          docker pull $CTN

          echo "üöÄ executando Arachni"
          docker run --rm \
            --network host \
            -v "${{ github.workspace }}":/zap/wrk \
            $CTN \
            arachni http://localhost:3000 \
              --report-save-path=/zap/wrk/$OUT \
              --timeout 1200

          echo "üìÑ gerando relat√≥rio HTML"
          docker run --rm \
            --network host \
            -v "${{ github.workspace }}":/zap/wrk \
            $CTN \
            arachni_reporter /zap/wrk/$OUT \
              --reporter=html:outfile=/zap/wrk/$HTML

      - name: Upload Arachni report
        uses: actions/upload-artifact@v4
        with:
          name: arachni-report
          path: juice_shop.html
